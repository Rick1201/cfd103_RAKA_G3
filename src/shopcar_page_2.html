<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./css/style.css"/>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/axios/0.8.1/axios.js' integrity='sha512-yQvhnV+bdDcAhyxTlmVUyNikQCtnIkfC9r7GesIjLg6IrJx2M92DSv58LpyobngV7WUeM1c3mpgP0971pIY98A==' crossorigin='anonymous'></script>
</head>
<body>
    @@include('./layout/header.html')
    <div class="check2">
        <div class="payment-page-step-btn">
                <p>填寫訂單</p>
        </div>
        <div class="payment-page-step-btn">
            <p>確認付款</p>
        </div>
        <div class="payment-page-step-btn5">
                <p>訂單完成</p>
        </div>
    </div>
    <section class="payment-page">
        <div class="receiver-box">
            <table class="receiver-tb">
                <th>收件人訊息</th>
                <tr>
                    <td class="receiver-title">姓名:</td>
                    <td id="name">?</td>
                </tr>
                <tr>
                    <td class="receiver-title">地址:</td>
                    <td id="address">?</td>
                </tr>
                <tr>
                    <td class="receiver-title">電話:</td>
                    <td id="tel">?</td>
                </tr>
                <tr>
                    <td class="receiver-title">備註:</td>
                    <td id="ps">?</td>
                </tr>
            </table>
        </div>
        <div class="order-box">
            <table class="order-tb">
                <th>訂單資料</th>
                <tr>
                    <td class="order-title">商品金額</td>
                    <td id="prodPrice"></td>
                </tr>
                <tr>
                    <td class="order-title">運費</td>
                    <td>$ 90</td>
                </tr>
                <tr>
                    <td class="order-title">總金額</td>
                    <td id="sum"></td>
                </tr>
            </table>
        </div>
        <div class="payment-box">
            <table class="payment-tb">
                <th>付款資訊</th>
                <tr class="payment-title">
                    <td>付款方式</td>
                    <td>
                        <select>
                            <option value="">信用卡</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td class="payment-title">信用卡號碼</td>
                    <td><input id="card" type="text" maxlength="16"></td>
                </tr>
                <tr>
                    <td class="payment-title">效期</td>
                    <td><input type="text" maxlength="4"></td>
                </tr>
                <tr>
                    <td class="payment-title">檢查碼</td>
                    <td><input type="text" maxlength="3"></td>
                </tr>
            </table>
        </div>
        <div class="payment-page-btn-box">
            <button class="payment-page-btn">
                <a href="./checkout_list.html">
                修改訂單資訊
                </a>
            </button>
            <button class="payment-page-btn"  id="submitOrder" type="button">
                確認付款
            </button>
        </div>
    </section>
    @@include('./layout/footer.html')
    <script>
        function submitOrder(){
            let orderInfo = JSON.parse(localStorage.getItem('orderInfo'));
            let addList = JSON.parse(localStorage.getItem('addList'));
            let memId = JSON.parse(localStorage.getItem('memberID'));
            let card = document.querySelector('#card').value;
            axios.post('./php/shopcar_page.php',{
            action:'insert',
            id:memId.Member_ID,
            sum:orderInfo.sum,
            ship:90,
            oTotal:orderInfo.total,
            oName:orderInfo.oName,
            oTel:orderInfo.oTel,
            oAddress:orderInfo.oAddress,
            oPs:orderInfo.oPs,
            oCard:card
            
            }).then(res=>{
                console.log(res.data);
                fetchAllData();
            })
        }

        function fetchAllData(){
            let orderId;
            let addList = JSON.parse(localStorage.getItem('addList'));
            axios.post("./php/shopcar_page2.php",
            {action:'fetchall'}).then(res=>{
            orderId = res.data[0].Order_ID;
            for(let i = 0; i< addList.length; i++ ){
                axios.post("./php/shopcar_page2.php",{
                action:'insert',
                orderId: orderId,
                productId: addList[i].Product_ID,
                count: addList[i].count,
                price: addList[i].Product_Price,
                });
            }

            localStorage.removeItem("addList");
            location.href="./checkout_final.html";
            });
        }
        // location.href = './checkout_final.html';
        function init(){
            let orderInfo = JSON.parse(localStorage.getItem('orderInfo'));
            let addList = JSON.parse(localStorage.getItem('addList'));

            document.querySelector('#name').innerText = orderInfo.oName;
            document.querySelector('#address').innerText = orderInfo.oAddress;
            document.querySelector('#tel').innerText = orderInfo.oTel;
            document.querySelector('#ps').innerText = orderInfo.oPs;


            document.querySelector('#prodPrice').innerText = orderInfo.sum;
            document.querySelector('#sum').innerText = `$ ${orderInfo.total}`;
            document.querySelector('#submitOrder').onclick = submitOrder;

        }
        window.addEventListener("load", init, false);
    </script>
</body>
</html>